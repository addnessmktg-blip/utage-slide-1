# 次世代動画ダウンローダー 技術調査レポート

## Phase 1: 技術調査と設計提案

作成日: 2025-12-17

---

## 1. 既存ツールの分析

### 1.1 Video DownloadHelper

**アーキテクチャ**
```
┌─────────────────────────────────────────────────────────────┐
│  Browser Extension (Manifest V2/V3)                         │
│  - DOM監視・ネットワークリクエスト検出                        │
│  - ユーザーインターフェース                                   │
└────────────────────────┬────────────────────────────────────┘
                         │ Native Messaging Protocol
                         ▼
┌─────────────────────────────────────────────────────────────┐
│  VdhCoApp (Native Companion App)                            │
│  - Node.js ベース                                           │
│  - ダウンロード処理・プロキシ機能                            │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│  FFmpeg (外部バイナリ)                                      │
│  - 動画/音声の結合・変換                                     │
│  - HLS/DASH セグメントのマージ                               │
└─────────────────────────────────────────────────────────────┘
```

**長所**
- ブラウザ統合による直感的なUX
- 20年近い実績と安定性
- 広範なサイト対応

**短所**
- Node.js + FFmpeg という重い依存関係（約200MB以上）
- インストールが複雑（拡張機能 + ネイティブアプリ）
- Manifest V3移行で機能制限
- メンテナンスコストが高い古典的アーキテクチャ

---

### 1.2 yt-dlp

**アーキテクチャ**
```
┌─────────────────────────────────────────────────────────────┐
│  YoutubeDL (メインオーケストレーター)                         │
├─────────────────────────────────────────────────────────────┤
│  Extractors (yt_dlp/extractor/)                             │
│  - サイトごとの専用パーサー（1000+サイト対応）                 │
│  - HTML/JSON解析、メタデータ抽出                              │
├─────────────────────────────────────────────────────────────┤
│  Downloader (yt_dlp/downloader/)                            │
│  - HTTP/HTTPS, HLS (m3u8), DASH (mpd)                       │
│  - フラグメントベースダウンロード                             │
├─────────────────────────────────────────────────────────────┤
│  Post-processors (yt_dlp/postprocessor/)                    │
│  - FFmpeg連携による変換                                      │
│  - メタデータ・字幕埋め込み                                   │
└─────────────────────────────────────────────────────────────┘
```

**長所**
- 圧倒的なサイト対応数（1000+）
- 活発なコミュニティメンテナンス
- Pythonライブラリとして組み込み可能
- 高度なフォーマット選択機能

**短所**
- Python実行環境が必要
- CLI中心でGUIは別途必要
- 起動時間がやや遅い（Python初期化）
- FFmpeg依存

---

### 1.3 cobalt.tools

**アーキテクチャ**
```
┌─────────────────────────────────────────────────────────────┐
│  Web Frontend (SvelteKit)                                   │
│  - モダンなSPA                                              │
│  - v11: デスクトップ版でオンデバイス処理                      │
└────────────────────────────┬────────────────────────────────┘
                             │ REST API
                             ▼
┌─────────────────────────────────────────────────────────────┐
│  Cobalt API Server (TypeScript/Node.js)                     │
│  - URL解析・メディア抽出                                     │
│  - プロキシ・リダイレクト処理                                 │
│  - 認証システム（v11以降）                                   │
└─────────────────────────────────────────────────────────────┘
```

**長所**
- クリーンなUI/UX
- オープンソース (AGPL-3.0)
- v11でオンデバイス処理対応（プライバシー向上）
- キャッシュなしのプロキシ方式

**短所**
- サーバー依存（セルフホスト可能だが複雑）
- 対応サイトが限定的（20+程度）
- 2024年以降、認証必須化でアクセス制限

---

### 1.4 既存ツール比較表

| 項目 | Video DownloadHelper | yt-dlp | cobalt.tools |
|------|---------------------|--------|--------------|
| **サイト対応** | 中（主要サイト） | 極大（1000+） | 小（20+） |
| **インストール** | 複雑 | やや複雑 | 不要（Web）/ 複雑（セルフホスト） |
| **依存関係** | Node.js + FFmpeg | Python + FFmpeg | Node.js（サーバー） |
| **UIの洗練度** | 普通 | CLI | 優秀 |
| **オフライン** | 部分的 | 完全対応 | 不可 |
| **更新頻度** | 低 | 高 | 中 |
| **メモリ使用量** | 高 | 中 | 低（Web版） |

---

## 2. 2025年時点で利用可能な最新技術

### 2.1 WebAssembly (ffmpeg.wasm)

**現状**
- ffmpeg.wasmはFFmpegをブラウザ内で実行可能にするWASMポート
- シングルスレッド版と@ffmpeg/core-mtマルチスレッド版が存在

**制限事項**
| 制限 | 詳細 |
|------|------|
| **メモリ上限** | 2GB（WASM仕様の制限、将来4GBに拡張予定） |
| **パフォーマンス** | ネイティブFFmpegの2-10倍遅い |
| **GPU非対応** | ハードウェアアクセラレーション不可 |
| **ファイルサイズ** | 入出力合計で2GBを超えると処理失敗 |
| **初期ロード** | WASMバイナリが大きい（〜25MB） |
| **メモリリーク** | 複数インスタンス生成時に問題あり |

**結論**: 短い動画や音声抽出には有用だが、大きなファイルや高品質動画のmuxingには不適切。

---

### 2.2 File System Access API

**機能**
- ブラウザからローカルファイルシステムへの直接読み書き
- ストリーミングダウンロード（部分的にダウンロードしながら再生可能）
- ユーザー許可でディレクトリアクセス

**制限事項**
```
❌ Firefox非対応（Brave削除済み）
❌ ユーザー操作ごとに許可プロンプト必須
❌ システムフォルダへのアクセス制限
❌ ファイル名の自動サニタイズなし
```

**結論**: Chromium系限定だが、大容量ファイルの直接保存には有効。

---

### 2.3 Manifest V3 の制約

**主要な制限**
| 制限 | 影響 |
|------|------|
| **Service Worker** | 永続的なバックグラウンド処理不可 |
| **webRequest API制限** | ネットワークリクエストの動的傍受が困難 |
| **リモートコード禁止** | 動的なextractor更新が不可能 |
| **タイムアウト** | Service Workerは30秒で終了 |

**回避策**
1. Content Scriptsでのビデオ要素直接検出
2. DeclarativeNetRequestで静的ルールベースの検出
3. Native Messagingでネイティブアプリに処理委譲
4. Offscreen Documentsで一時的なDOM処理

**結論**: 純粋な拡張機能のみでの動画ダウンロードは困難。ネイティブ連携が必須。

---

### 2.4 Tauri vs Electron vs Native Messaging

#### Tauri 2.0 (2024年10月安定版リリース)

**特徴**
- Rust製バックエンド + OS標準WebView
- アプリサイズ: 3-10MB（Electron比 1/30〜1/10）
- メモリ使用量: 50-100MB（Electron比 1/4〜1/8）
- 起動時間: 0.5秒以下
- iOS/Android対応（v2.0〜）

**動画ダウンローダーに関連する機能**
- `on_download` APIでダウンロード制御
- 強力なIPC（フロントエンド⇔Rust）
- プラグインシステムでFFmpeg統合可能
- セキュアなパーミッションシステム

#### Electron

**特徴**
- Chromium + Node.js バンドル
- アプリサイズ: 100MB以上
- メモリ使用量: 400MB以上
- 豊富なエコシステムと実績

#### Native Messaging

**特徴**
- ブラウザ拡張 + ネイティブアプリの連携
- 既存ブラウザのUXを活用
- インストールが複雑

#### 比較表

| 項目 | Tauri 2.0 | Electron | Native Messaging |
|------|-----------|----------|------------------|
| **アプリサイズ** | 3-10MB | 100MB+ | 可変 |
| **メモリ使用量** | 50-100MB | 400MB+ | 可変 |
| **起動速度** | 0.5秒以下 | 1-2秒 | ブラウザ依存 |
| **クロスプラットフォーム** | Win/Mac/Linux/iOS/Android | Win/Mac/Linux | Win/Mac/Linux |
| **WebView一貫性** | OS依存でばらつきあり | Chromiumで一貫 | ブラウザ依存 |
| **開発言語** | Rust + JS/TS | JS/TS | 任意 |
| **学習コスト** | 中〜高 | 低 | 中 |
| **FFmpeg統合** | sidecarまたはRustバインディング | 容易 | 容易 |

---

### 2.5 Rust/Go でのネイティブ実装

#### Rust のメリット

**VSD (Video Stream Downloader)**
- HLS/DASH両対応
- AES-128/CENC復号対応
- マルチスレッドダウンロード
- FFmpegとのmuxing連携

**関連ライブラリ**
```
- reqwest: HTTP クライアント
- tokio: 非同期ランタイム
- m3u8-rs: HLS パーサー
- dash-mpd: DASH MPD パーサー
- ffmpeg-next: FFmpeg Rust バインディング
```

#### Go のメリット

**Lux (旧 Annie)**
- 50+サイト対応
- シングルバイナリ（デプロイ容易）
- 高速な実行
- FFmpeg連携

**kkdai/youtube**
- YouTube専用の軽量ライブラリ
- トランスクリプト取得対応

#### 言語比較

| 項目 | Rust | Go |
|------|------|-----|
| **パフォーマンス** | 最高 | 高 |
| **バイナリサイズ** | 小 | 中 |
| **メモリ安全性** | コンパイル時保証 | GC依存 |
| **並行処理** | async/await + tokio | goroutine |
| **学習曲線** | 急 | 緩やか |
| **Tauri統合** | ネイティブ | FFI必要 |

---

### 2.6 その他の革新的アプローチ

#### WebRTC経由のP2P配信
- ブラウザ間でのセグメント共有
- CDN負荷軽減・高速化
- 実装複雑度が高い

#### Origin Private File System (OPFS)
- ブラウザ内のプライベートファイルシステム
- 高速なファイルI/O
- IndexedDBより効率的
- ただしクォータ制限あり

#### WebCodecs API
- ブラウザ内での低レベル動画エンコード/デコード
- ハードウェアアクセラレーション対応
- 2024年時点ではまだ限定的な実装

---

## 3. アーキテクチャ提案

### 選択肢A: フルブラウザ完結型

```
┌─────────────────────────────────────────────────────────────┐
│  Chrome Extension (Manifest V3)                             │
│  - Content Script: 動画検出                                  │
│  - Service Worker: ダウンロード管理                          │
│  - Offscreen Document: 重い処理                              │
├─────────────────────────────────────────────────────────────┤
│  ffmpeg.wasm                                                │
│  - 軽量な変換・muxing                                        │
├─────────────────────────────────────────────────────────────┤
│  File System Access API / Download API                      │
│  - ファイル保存                                              │
└─────────────────────────────────────────────────────────────┘
```

**メリット**
- インストール不要（拡張のみ）
- ネイティブアプリ不要
- アップデートが容易

**デメリット**
- 2GB以上のファイル処理不可
- Firefox非対応
- パフォーマンス制限
- Manifest V3制約

**向いているケース**: 軽量な動画（数分の短い動画）のみ

**評価: ⭐⭐ (2/5)** - 制約が多すぎて本格的な用途には不向き

---

### 選択肢B: 軽量ネイティブ連携型

```
┌─────────────────────────────────────────────────────────────┐
│  Chrome Extension (Manifest V3)                             │
│  - Content Script: 動画URL検出                               │
│  - Popup UI: ダウンロード操作                                │
└────────────────────────┬────────────────────────────────────┘
                         │ Native Messaging
                         ▼
┌─────────────────────────────────────────────────────────────┐
│  Rust CLI / Daemon                                          │
│  - 軽量（5MB以下のシングルバイナリ）                          │
│  - HLS/DASHダウンロード                                      │
│  - WebSocket/HTTP APIでフロントエンドと通信                   │
├─────────────────────────────────────────────────────────────┤
│  Bundled FFmpeg (static build)                              │
│  - 必要な機能のみの最小ビルド（〜30MB）                       │
└─────────────────────────────────────────────────────────────┘
```

**メリット**
- ブラウザとのシームレスな統合
- 軽量なネイティブコンポーネント
- 高性能な処理
- 既存のブラウザUXを活用

**デメリット**
- 2つのコンポーネントのインストールが必要
- ブラウザ依存
- 複数ブラウザ対応が手間

**向いているケース**: ブラウザ中心のワークフローを好むユーザー

**評価: ⭐⭐⭐ (3/5)** - Video DownloadHelperの現代版

---

### 選択肢C: Tauri デスクトップアプリ型 【推奨】

```
┌─────────────────────────────────────────────────────────────┐
│  Tauri 2.0 Application                                      │
├─────────────────────────────────────────────────────────────┤
│  Frontend (TypeScript + React/Svelte)                       │
│  - モダンなUI（ダークテーマ）                                 │
│  - ダウンロードキュー管理                                     │
│  - プログレス表示                                            │
├─────────────────────────────────────────────────────────────┤
│  Rust Backend                                               │
│  - URL解析・メタデータ抽出                                   │
│  - HLS/DASHセグメントダウンロード                            │
│  - 並行ダウンロード処理                                      │
│  - FFmpeg連携（sidecar）                                    │
├─────────────────────────────────────────────────────────────┤
│  FFmpeg Sidecar                                             │
│  - 動画/音声muxing                                          │
│  - フォーマット変換                                          │
│  - 字幕埋め込み                                              │
└─────────────────────────────────────────────────────────────┘

              Optional Browser Integration
┌─────────────────────────────────────────────────────────────┐
│  Companion Extension (optional)                             │
│  - 「Tauriアプリで開く」ボタン                                │
│  - URL転送のみ（ローカルHTTP API経由）                        │
└─────────────────────────────────────────────────────────────┘
```

**メリット**
- 軽量（インストーラー10MB以下、FFmpeg込みでも50MB程度）
- 高速な起動・動作
- フル機能（大容量ファイル対応）
- ブラウザ非依存（スタンドアロン動作可能）
- クロスプラットフォーム（Win/Mac/Linux）
- Rustによる安全性とパフォーマンス
- モダンなUI/UX

**デメリット**
- Rustの学習コスト
- WebViewのOS間差異（軽微）
- ブラウザ統合は別途拡張が必要

**向いているケース**: 本格的な動画ダウンロード

**評価: ⭐⭐⭐⭐⭐ (5/5)** - 2025年の最適解

---

### 選択肢D: Electron デスクトップアプリ型

```
┌─────────────────────────────────────────────────────────────┐
│  Electron Application                                       │
│  - Chromium + Node.js バンドル                              │
│  - node-yt-dlp ラッパー使用可能                              │
│  - fluent-ffmpeg for Node.js                                │
└─────────────────────────────────────────────────────────────┘
```

**メリット**
- 豊富なnpmエコシステム
- Web開発者にとって馴染みやすい
- yt-dlpのNodeラッパーが利用可能

**デメリット**
- 巨大なアプリサイズ（200MB+）
- 高メモリ消費（400MB+）
- 起動が遅い

**評価: ⭐⭐⭐ (3/5)** - 動作するが効率が悪い

---

## 4. 推奨構成: Tauri 2.0 + Rust Backend

### 4.1 推奨理由

1. **軽量性**: Electron比で1/20のサイズ、1/4のメモリ
2. **パフォーマンス**: Rustの高速性 + ネイティブFFmpeg
3. **モダン性**: 2024年末に安定版リリースされた最新技術
4. **保守性**: TypeScript (Frontend) + Rust (Backend) の型安全性
5. **拡張性**: プラグインシステムで機能追加容易
6. **ユーザー体験**: ワンクリックインストーラー

### 4.2 技術スタック

```yaml
Frontend:
  - Framework: React 18 + TypeScript
  - UI Library: shadcn/ui (Tailwind CSS)
  - State: Zustand
  - Build: Vite

Backend (Rust):
  - HTTP Client: reqwest
  - Async Runtime: tokio
  - HLS Parser: m3u8-rs
  - DASH Parser: dash-mpd
  - Serialization: serde
  - IPC: tauri

External:
  - FFmpeg: sidecar (static build)

Testing:
  - Frontend: Vitest + Testing Library
  - Backend: Rust標準テスト
```

### 4.3 ディレクトリ構成

```
video-downloader/
├── src-tauri/           # Rust Backend
│   ├── src/
│   │   ├── main.rs
│   │   ├── commands/    # Tauri コマンド
│   │   ├── extractors/  # サイト別エクストラクター
│   │   ├── downloader/  # ダウンロード処理
│   │   └── ffmpeg/      # FFmpeg連携
│   ├── Cargo.toml
│   └── tauri.conf.json
├── src/                 # Frontend
│   ├── components/
│   ├── hooks/
│   ├── stores/
│   └── App.tsx
├── package.json
└── README.md
```

---

## 5. 質問事項

実装に進む前に、以下を確認させてください：

### 5.1 優先度について

1. **対応サイトの優先順位**
   - YouTube > Twitter/X > TikTok > Vimeo > その他埋め込み
   - この順序で正しいですか？

2. **ブラウザ連携の必要性**
   - オプションのコンパニオン拡張機能は必要ですか？
   - それとも「URLをコピペ」で十分ですか？

### 5.2 技術的な確認

3. **FFmpegのバンドル方法**
   - 推奨: 最小構成のstatic FFmpegをsidecarとしてバンドル
   - 代替: システムのFFmpegを利用（ユーザーに事前インストールを要求）
   - どちらを希望しますか？

4. **UI フレームワーク**
   - React（推奨: エコシステムの豊富さ）
   - Svelte（より軽量、学習容易）
   - Solid（最高のパフォーマンス）
   - ご希望はありますか？

### 5.3 機能の確認

5. **認証が必要なサイトへの対応**
   - YouTube Premium、Twitter/Xのログインが必要なコンテンツ
   - Cookieインポート機能は必要ですか？

6. **プレイリストの自動検出**
   - YouTubeプレイリストURL以外に、チャンネル全体のダウンロードも対応しますか？

---

## 6. 次のステップ

ご承認いただければ、以下の順序で実装を進めます：

1. **Tauri プロジェクトの初期化**
2. **UI 基本実装**（ダークテーマ、ダウンロードキュー）
3. **YouTube エクストラクター実装**
4. **HLS/DASH ダウンローダー実装**
5. **FFmpeg 連携**（sidecar）
6. **他サイト対応の追加**
7. **テスト・ドキュメント整備**
8. **クロスプラットフォームビルド**

---

## 参考リンク

### 既存ツール
- [cobalt.tools GitHub](https://github.com/imputnet/cobalt)
- [yt-dlp GitHub](https://github.com/yt-dlp/yt-dlp)
- [Lux (Go Video Downloader)](https://github.com/iawia002/lux)

### 技術ドキュメント
- [Tauri 2.0 公式](https://v2.tauri.app/)
- [ffmpeg.wasm](https://ffmpegwasm.netlify.app/)
- [File System Access API (MDN)](https://developer.mozilla.org/en-US/docs/Web/API/File_System_API)
- [Chrome Manifest V3](https://developer.chrome.com/docs/extensions/mv3/intro/)

### Rustライブラリ
- [vsd (Video Stream Downloader)](https://lib.rs/crates/vsd)
- [dash-mpd-cli](https://lib.rs/crates/dash-mpd-cli)
